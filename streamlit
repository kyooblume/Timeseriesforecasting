import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import xgboost as xgb
from sklearn.metrics import mean_absolute_percentage_error
from sklearn.feature_selection import RFECV

# Streamlit ã‚¢ãƒ—ãƒªã®ã‚¿ã‚¤ãƒˆãƒ«
st.title("ğŸ“Š æ™‚ç³»åˆ—äºˆæ¸¬")

# ãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’åˆæœŸåŒ–ï¼ˆåˆå›èµ·å‹•æ™‚ï¼‰
if "df" not in st.session_state:
    st.session_state["df"] = None

# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ãƒ•ã‚§ãƒ¼ã‚ºé¸æŠã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
phase = st.sidebar.selectbox("ãƒ•ã‚§ãƒ¼ã‚ºã‚’é¸æŠã—ã¦ãã ã•ã„", ["1.ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", "2.ãƒ‡ãƒ¼ã‚¿å‹ã®å¤‰æ›´", "3.åˆ†æ"])

if phase == "1.ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰":
    st.write("### ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
    uploaded_file = st.file_uploader("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type=["csv", "xlsx", "txt", "json"])

    if uploaded_file is not None:
        file_extension = uploaded_file.name.split(".")[-1]

        try:
            if file_extension == "csv":
                df = pd.read_csv(uploaded_file, encoding="utf-8-sig")
            elif file_extension == "xlsx":
                xls = pd.ExcelFile(uploaded_file)
                sheet_name = st.selectbox("ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„", xls.sheet_names)
                df = pd.read_excel(uploaded_file, sheet_name=sheet_name)
            elif file_extension == "txt":
                delimiter = st.selectbox("åŒºåˆ‡ã‚Šæ–‡å­—ã‚’é¸æŠã—ã¦ãã ã•ã„", ["\t", " "])
                df = pd.read_csv(uploaded_file, delimiter=delimiter, encoding="utf-8-sig")
            elif file_extension == "json":
                df = pd.read_json(uploaded_file)
            else:
                st.error("å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚")
                st.stop()

            # èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
            st.session_state["df"] = df
            st.success("âœ… ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿æˆåŠŸï¼")
        except Exception as e:
            st.error(f"âŒ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

elif phase == "2.ãƒ‡ãƒ¼ã‚¿å‹ã®å¤‰æ›´":
    st.subheader("ãƒ‡ãƒ¼ã‚¿å‹ã®å¤‰æ›´")
    st.write("åŸºæœ¬çš„ã«ã¯ç„¡è¦–ã—ã¦ãã ã•ã„")
    df = st.session_state.get("df")

    if df is not None:
        for column in df.columns:
            dtype = st.selectbox(f"{column} ã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’é¸æŠã—ã¦ãã ã•ã„", ["è‡ªå‹•æ¤œå‡º", "æ•´æ•°", "æµ®å‹•å°æ•°ç‚¹æ•°", "æ–‡å­—åˆ—", "æ—¥ä»˜", "ãƒã‚¤ãƒŠãƒª"], key=column)
            if dtype == "æ•´æ•°":
                df[column] = pd.to_numeric(df[column], errors="coerce").astype("Int64")
            elif dtype == "æµ®å‹•å°æ•°ç‚¹æ•°":
                df[column] = pd.to_numeric(df[column], errors="coerce")
            elif dtype == "æ–‡å­—åˆ—":
                df[column] = df[column].astype(str)
            elif dtype == "æ—¥ä»˜":
                df[column] = pd.to_datetime(df[column], errors="coerce")
            elif dtype == "ãƒã‚¤ãƒŠãƒª":
                df[column] = df[column].astype("bool")

        # å¤‰æ›´å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
        st.session_state["df"] = df
    else:
        st.warning("âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã¾ãšã¯1ã§ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")

elif phase == "3.åˆ†æ":
    df = st.session_state.get("df")

    if df is not None and "yyyymmdd" in df.columns:
        df["yyyymmdd"] = pd.to_datetime(df["yyyymmdd"], errors="coerce")
        df.dropna(subset=["yyyymmdd"], inplace=True)
        min_date, max_date = df["yyyymmdd"].min(), df["yyyymmdd"].max()

        # ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æœŸé–“ã¨ãƒ†ã‚¹ãƒˆæœŸé–“ã®é¸æŠ
        train_start, train_end = st.date_input(
            "ğŸ“… ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®æœŸé–“", 
            value=(min_date, max_date - pd.DateOffset(months=1)), 
            min_value=min_date, max_value=max_date
        )
        test_start, test_end = st.date_input(
            "ğŸ“… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æœŸé–“", 
            value=(max_date - pd.DateOffset(months=1), max_date), 
            min_value=min_date, max_value=max_date
        )

        # ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²
        df_train = df[(df["yyyymmdd"] >= pd.to_datetime(train_start)) & (df["yyyymmdd"] <= pd.to_datetime(train_end))]
        df_test = df[(df["yyyymmdd"] >= pd.to_datetime(test_start)) & (df["yyyymmdd"] <= pd.to_datetime(test_end))]

        # äºˆæ¸¬å¯¾è±¡å¤‰æ•°ã®é¸æŠ
        selected_variable = st.selectbox("ğŸ“Œ äºˆæ¸¬ã™ã‚‹å¤‰æ•°ã‚’é¸æŠ", df_train.select_dtypes(include=["number"]).columns)

        # ç‰¹å¾´é‡é¸æŠ
        # äº¤å·®æ¤œè¨¼ã®ã‚»ãƒƒãƒˆã‚’å®šç¾©
        validation_sets = [...]  # äº¤å·®æ¤œè¨¼ã‚»ãƒƒãƒˆã‚’æŒ‡å®š

        # ç‰¹å¾´é‡é¸æŠã®ãŸã‚ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ    
        selected_features = []
        scores = []

        for i, (X_train_set, y_train_set, X_val_set, y_val_set) in enumerate(validation_sets):
            # RFECVã§ç‰¹å¾´é‡é¸æŠ
            rfecv = RFECV(estimator=xgb.XGBRegressor(random_state=100),
                          min_features_to_select=11,
                          step=0.5,
                          n_jobs=1,
                          scoring='neg_mean_absolute_percentage_error')

            # ç‰¹å¾´é‡é¸æŠã®ãƒ•ã‚£ãƒƒãƒˆ
            rfecv.fit(X_train_set, y_train_set)

            # é¸ã°ã‚ŒãŸç‰¹å¾´é‡ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
            columns_selected = X_train_set.columns[rfecv.support_].tolist()
            selected_features.append(columns_selected)
            print(f"ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒƒãƒˆ {i+1}: ç‰¹å¾´é‡ã®æ•°: {rfecv.n_features_}")
            print(f"é¸æŠã•ã‚ŒãŸç‰¹å¾´é‡: {columns_selected}")

            # é¸æŠã•ã‚ŒãŸç‰¹å¾´é‡ã‚’ä½¿ã£ã¦X_trainã¨X_valã‚’ä½œæˆ
            X_train_selected = X_train_set[columns_selected]
            X_val_selected = X_val_set[columns_selected]

            # XGBoostãƒ¢ãƒ‡ãƒ«ã‚’è¨“ç·´
            model = xgb.XGBRegressor(random_state=99)
            model.fit(X_train_selected, y_train_set)

            # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒƒãƒˆã§äºˆæ¸¬
            y_val_pred = model.predict(X_val_selected)


        # ãƒ¢ãƒ‡ãƒ«å­¦ç¿’
        try:
            model = xgb.XGBRegressor(objective="reg:squarederror", n_estimators=100, learning_rate=0.1)
            model.fit(df_train[selected_features], df_train[selected_variable])
            y_pred = model.predict(df_test[selected_features])

            st.subheader(f"ğŸ“ˆ {selected_variable} ã®äºˆæ¸¬çµæœ")

            # äºˆæ¸¬çµæœã®è¡¨ç¤º
            st.write("âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼", df_test.head())
            st.write("âœ… äºˆæ¸¬çµæœã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼", y_pred[:5])

            if len(df_test) > 0 and len(y_pred) > 0:
                fig, ax = plt.subplots(figsize=(12, 6))
                ax.plot(df_test["yyyymmdd"], df_test[selected_variable], label="Actual", marker="o", color="blue")
                ax.plot(df_test["yyyymmdd"], y_pred, label="Predicted", marker="x", color="red")
                ax.set_title(f"{selected_variable} ã®äºˆæ¸¬çµæœ")
                plt.xticks(rotation=45)
                plt.legend()
                st.pyplot(fig)

                # MAPEã®è¨ˆç®—ã¨è¡¨ç¤º
                mape = mean_absolute_percentage_error(df_test[selected_variable], y_pred)
                st.write(f"âœ… **MAPE**: {mape:.2f}%")

                # ãƒ¢ãƒ‡ãƒ«ç²¾åº¦ã®è©•ä¾¡
                if mape <= 8.5:
                    st.success("âœ… ãƒ¢ãƒ‡ãƒ«ç²¾åº¦ã¯è‰¯å¥½ã§ã™ã€‚äºˆæ¸¬çµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚")
                else:
                    st.error("âš ï¸ ãƒ¢ãƒ‡ãƒ«ç²¾åº¦ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®è¦‹ç›´ã—ãŒå¿…è¦ã§ã™ã€‚")
            else:
                st.warning("âš ï¸ äºˆæ¸¬çµæœã¾ãŸã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®ç¯„å›²ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")

        except Exception as e:
            st.error(f"âŒ ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ã¾ãŸã¯äºˆæ¸¬ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

    else:
        st.warning("âš ï¸ 'yyyymmdd' ã‚«ãƒ©ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")


















# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã®åˆæœŸåŒ–
if "show_form" not in st.session_state:
    st.session_state["show_form"] = False
if "show_qa" not in st.session_state:
    st.session_state["show_qa"] = False

# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ãƒœã‚¿ãƒ³ã‚’è¨­ç½®
with st.sidebar:
    if st.button("Q&A"):
        st.session_state["show_qa"] = not st.session_state["show_qa"]

    if st.button("è³ªå•ãƒ•ã‚©ãƒ¼ãƒ "):
        st.session_state["show_form"] = not st.session_state["show_form"]

    # Q&Aã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºï¼ˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã ã‘ï¼‰
    if st.session_state["show_qa"]:
        st.write("### ã‚ˆãã‚ã‚‹è³ªå•")
        st.write("**Q1: ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æœŸé–“ã®ç›®å®‰ã¯ï¼Ÿ**")
        st.write("A1: æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ã®å ´åˆæœ€ä½ã§ã‚‚ 3å¹´åˆ†ã€å¹´æ¬¡ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯æœ€ä½ã§ã‚‚ 20å¹´åˆ†ã‚’æ¨å¥¨ã—ã¾ã™ã€‚")
        
        st.write("**Q2: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã¯ï¼Ÿ**")
        st.write("A2: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã¯ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸã€ãƒªãƒ³ã‚¯ã‹ã‚‰å†è¨­å®šã§ãã¾ã™ã€‚")
        
        st.write("**Q3: ãŠå•ã„åˆã‚ã›æ–¹æ³•ã¯ï¼Ÿ**")
        st.write("A3: æ“ä½œæ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„ã€æ­£ã—ãæ“ä½œã—ã¦ã„ã‚‹ã¯ãšãªã®ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã€ãƒ¢ãƒ‡ãƒ«ç²¾åº¦ãŒã©ã†ã—ã¦ã‚‚å‡ºãªã„ãªã©ã€è³ªå•ãƒ»ã”ç›¸è«‡ãŒã‚ã‚‹æ–¹ã¯ä»¥ä¸‹é€£çµ¡å…ˆã«çŠ¶æ³ã‚’ã”é€£çµ¡ãã ã•ã„ã€‚æ‹…å½“è€…ã‚ˆã‚Šè¿”ä¿¡ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚<br>å•ã„åˆã‚ã›å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼šcontact@b-mystory.com<br>æ‹…å½“ï¼šä½œç”°ã€é‡æœ¬", unsafe_allow_html=True)

    # ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºï¼ˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã ã‘ï¼‰
    if st.session_state["show_form"]:
        st.write("### è³ªå•")
        with st.form("user_form"):
            name = st.text_input("åå‰")
            email = st.text_input("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹")
            question = st.text_area("è³ªå•å†…å®¹")
            submitted = st.form_submit_button("é€ä¿¡")

            if submitted:
                st.success(f"é€ä¿¡å®Œäº†ï¼\nåå‰: {name}, ãƒ¡ãƒ¼ãƒ«: {email}")










